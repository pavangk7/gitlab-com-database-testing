From 19c21e7028da0437c7b2f891227eec808b45a0fb Mon Sep 17 00:00:00 2001
From: Simon Tomlinson <stomlinson@gitlab.com>
Date: Thu, 6 Oct 2022 14:48:40 -0500
Subject: [PATCH] Patch for testing batched background migrations

---
 ..._test_batched_background_migration_main.rb | 16 ++++++++
 ...ue_test_batched_background_migration_ci.rb | 38 +++++++++++++++++++
 2 files changed, 54 insertions(+)
 create mode 100644 db/migrate/20221006193625_queue_test_batched_background_migration_main.rb
 create mode 100644 db/migrate/20221006193710_queue_test_batched_background_migration_ci.rb

diff --git a/db/migrate/20221006193625_queue_test_batched_background_migration_main.rb b/db/migrate/20221006193625_queue_test_batched_background_migration_main.rb
new file mode 100644
index 000000000000..4f434dd230f9
--- /dev/null
+++ b/db/migrate/20221006193625_queue_test_batched_background_migration_main.rb
@@ -0,0 +1,16 @@
+# frozen_string_literal: true
+
+class QueueTestBatchedBackgroundMigrationMain < Gitlab::Database::Migration[2.0]
+  restrict_gitlab_migration gitlab_schema: :gitlab_main
+
+  def up
+    # Test background migration that sets created_at = updated_at for issues rows
+    queue_batched_background_migration(
+      'CopyColumnUsingBackgroundMigrationJob',
+      :issues,
+      :id,
+      :updated_at, :created_at,
+      job_interval: 2.minutes
+    )
+  end
+end
diff --git a/db/migrate/20221006193710_queue_test_batched_background_migration_ci.rb b/db/migrate/20221006193710_queue_test_batched_background_migration_ci.rb
new file mode 100644
index 000000000000..7d2176cd3a30
--- /dev/null
+++ b/db/migrate/20221006193710_queue_test_batched_background_migration_ci.rb
@@ -0,0 +1,38 @@
+# frozen_string_literal: true
+
+# See https://docs.gitlab.com/ee/development/migration_style_guide.html
+# for more information on how to write migrations for GitLab.
+
+class QueueTestBatchedBackgroundMigrationCi < Gitlab::Database::Migration[2.0]
+  # When using the methods "add_concurrent_index" or "remove_concurrent_index"
+  # you must disable the use of transactions
+  # as these methods can not run in an existing transaction.
+  # When using "add_concurrent_index" or "remove_concurrent_index" methods make sure
+  # that either of them is the _only_ method called in the migration,
+  # any other changes should go in a separate migration.
+  # This ensures that upon failure _only_ the index creation or removing fails
+  # and can be retried or reverted easily.
+  #
+  # To disable transactions uncomment the following line and remove these
+  # comments:
+  # disable_ddl_transaction!
+  #
+  # Configure the `gitlab_schema` to perform data manipulation (DML).
+  # Visit: https://docs.gitlab.com/ee/development/database/migrations_for_multiple_databases.html
+  # restrict_gitlab_migration gitlab_schema: :gitlab_main
+
+  def change
+    def up
+      # Test background migration that sets created_at = updated_at for ci_runner_projects rows
+      # ci_runner_projects was chosen as a CI table that's not likely to be partitioned in the future, but we may need
+      # to change this test if that changes
+      queue_batched_background_migration(
+        'CopyColumnUsingBackgroundMigrationJob',
+        :ci_runner_projects,
+        :id,
+        :updated_at, :created_at,
+        job_interval: 2.minutes
+      )
+    end
+  end
+end
-- 
2.37.1

